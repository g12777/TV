name: Sync Logos

on:
  push:
    branches:
      - main
  workflow_dispatch:

# ğŸ”‘ é™åˆ¶åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ª workflow è¿è¡Œ
concurrency:
  group: sync-push
  cancel-in-progress: false

jobs:
  sync-logos:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # å…è®¸å†™å…¥ä»£ç åº“

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Find duplicate PNG filenames
        run: |
          echo "æ£€æŸ¥é‡å¤æ–‡ä»¶..."
          find assets/logos -type f -name "*.png" -printf "%f %p\n" | \
          awk '{count[$1]++; paths[$1]=paths[$1]"\n"$2} END {for (f in count) if (count[f]>1) {print "é‡å¤æ–‡ä»¶:" f paths[f]}}'

      - name: Sync PNG files (flatten into logo/, with special copies)
        run: |
          mkdir -p logo
          rm -rf tmp-logos && mkdir tmp-logos

          # å®šä¹‰éœ€è¦é¢å¤–å¤åˆ¶çš„ç›®å½•åˆ—è¡¨
          SPECIAL_DIRS=("NEWTV" "SITV" "IHOT" "IPTV")

          # éå†æ‰€æœ‰ PNG æ–‡ä»¶
          find assets/logos -type f -name "*.png" | while read filepath; do
            filename=$(basename "$filepath")
            dirname=$(basename "$(dirname "$filepath")")

            # å¹³é“ºå¤åˆ¶
            cp "$filepath" "tmp-logos/$filename"

            # å¦‚æœæ‰€åœ¨æ–‡ä»¶å¤¹åœ¨ç‰¹æ®Šåˆ—è¡¨é‡Œï¼Œé¢å¤–å¤åˆ¶ä¸€ä»½
            for d in "${SPECIAL_DIRS[@]}"; do
              if [[ "$dirname" == "$d" ]]; then
                cp "$filepath" "tmp-logos/${d}${filename}"
              fi
            done
          done

          # ç”¨ rsync åŒæ­¥åˆ° logo æ–‡ä»¶å¤¹ï¼Œä¿è¯æ–°å¢/æ›¿æ¢/åˆ é™¤
          rsync -av --delete tmp-logos/ logo/
          rm -rf tmp-logos

      - name: Commit and Push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add logo
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
            exit 0
          fi

          now_time=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
          git commit -m "æ›´æ–°æ—¶é—´ï¼š$now_time"

          # ğŸ”‘ æ‹‰å–è¿œç¨‹æœ€æ–° commitï¼Œé¿å… fast-forward è¢«æ‹’ç»
          git fetch origin main
          git rebase origin/main
          
          git push
