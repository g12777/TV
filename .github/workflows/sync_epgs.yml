name: Sync EPG Files

on:
  push:
    branches:
      - main
  schedule:
    # GitHub Actions ä½¿ç”¨ UTC æ—¶é—´
    - cron: '40 16 * * *'  # 00:40 CST
    - cron: '15 2 * * *'   # 10:15 CST
    - cron: '0 7 * * *'    # 15:00 CST
  workflow_dispatch:

# ğŸ”‘ é™åˆ¶åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ª workflow è¿è¡Œ
concurrency:
  group: sync-push
  cancel-in-progress: false

jobs:
  sync-epg:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # å…è®¸å†™å…¥ä»“åº“
    timeout-minutes: 30   # æ•´ä¸ª job æœ€å¤šè¿è¡Œ 30 åˆ†é’Ÿ

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download EPG files
        run: |
          mkdir -p epg

          download() {
            url="$1"
            output="$2"
            retries=5
            delay=10
            count=0
            success=0

            while [ $count -lt $retries ]; do
              echo "â¬‡ï¸ [å°è¯• $((count+1))/$retries] ä¸‹è½½ $url ..."
              if curl --retry 3 \
                        "$url" -o "$output"; then
                if [ -s "$output" ]; then
                  echo "âœ… æˆåŠŸä¸‹è½½ $url"
                  success=1
                  break
                else
                  echo "âš ï¸ ä¸‹è½½åˆ°ç©ºæ–‡ä»¶ï¼Œé‡è¯•..."
                fi
              else
                echo "âŒ ä¸‹è½½å¤±è´¥ï¼š$url"
              fi
              count=$((count+1))
              sleep $delay
            done

            if [ $success -eq 0 ]; then
              echo "ğŸš¨ å¤šæ¬¡é‡è¯•å¤±è´¥ï¼Œè·³è¿‡ï¼š$url"
              echo "<error>failed to download $url</error>" > "$output"
            fi
          }

          # ä¸‹è½½åˆ—è¡¨
          download http://e.erw.cc/all.xml epg/all.xml
          download http://e.erw.cc/e.xml epg/e.xml
          download https://epg.112114.xyz/pp.xml epg/112114.xml

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add epg/*
          if ! git diff --cached --quiet; then
            now_time=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
            git commit -m "æ›´æ–°æ—¶é—´ï¼š$now_time"

            # ğŸ”‘ æ‹‰å–è¿œç¨‹æœ€æ–° commitï¼Œé¿å… fast-forward è¢«æ‹’ç»
            git fetch origin main
            git rebase origin/main

            git push origin main || echo "æ¨é€åˆ°GitHubå¤±è´¥"
          else
            echo "æ²¡æœ‰æ–‡ä»¶å¯æäº¤"
          fi

