name: Sync EPG Files

on:
  push:
    branches:
      - main
  schedule:
    # GitHub Actions ä½¿ç”¨ UTC æ—¶é—´
    - cron: '40 16 * * *'  # 00:40 CST
    - cron: '15 2 * * *'   # 10:15 CST
    - cron: '0 7 * * *'    # 15:00 CST
  workflow_dispatch:

concurrency:
  group: sync-push
  cancel-in-progress: false

jobs:
  sync-epg:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download EPG files
        run: |
          mkdir -p epg

          download() {
            url="$1"
            output="$2"
            retries=5
            delay=10
            count=0
            success=0

            while [ $count -lt $retries ]; do
              echo "â¬‡ï¸ [å°è¯• $((count+1))/$retries] ä¸‹è½½ $url ..."
              if curl --retry 3 "$url" -o "$output"; then
                if [ -s "$output" ]; then
                  echo "âœ… æˆåŠŸä¸‹è½½ $url"
                  success=1
                  break
                else
                  echo "âš ï¸ ä¸‹è½½åˆ°ç©ºæ–‡ä»¶ï¼Œé‡è¯•..."
                fi
              else
                echo "âŒ ä¸‹è½½å¤±è´¥ï¼š$url"
              fi
              count=$((count+1))
              sleep $delay
            done

            if [ $success -eq 0 ]; then
              echo "ğŸš¨ å¤šæ¬¡é‡è¯•å¤±è´¥ï¼Œè·³è¿‡ï¼š$url"
              echo "<error>failed to download $url</error>" > "$output"
            fi
          }

          # ä¸‹è½½åˆ—è¡¨
          download http://e.erw.cc/e.xml epg/e.xml
          download http://e.erw.cc/all.xml epg/all.xml
          download https://raw.githubusercontent.com/plsy1/epg/main/e/e.xml epg/plsy1_1d.xml
          download https://raw.githubusercontent.com/plsy1/epg/main/e/seven-days.xml epg/plsy1_7d.xml
          download https://epg.112114.xyz/pp.xml epg/112114.xml

      - name: Merge EPG files
        run: |
          echo "â–¶ï¸ æ‰§è¡Œ Python è„šæœ¬åˆå¹¶ EPG"
          python3 scripts/merge_epg.py

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add epg/*
          if ! git diff --cached --quiet; then
            now_time=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
            git commit -m "æ›´æ–°æ—¶é—´ï¼š$now_time"

            git fetch origin main
            git rebase origin/main

            git push origin main || echo "æ¨é€åˆ°GitHubå¤±è´¥"
          else
            echo "æ²¡æœ‰æ–‡ä»¶å¯æäº¤"
          fi

      - name: Copy file tvsilo
        if: env.SKIP_BUILD != 'true'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER1_HOST }}
          username: ${{ secrets.SERVER1_USER }}
          key: ${{ secrets.SERVER1_SSH_KEY }}
          source: "epg/*"
          target: "/www/wwwroot/tvsilo.vip/epg/"
          strip_components: 1
          overwrite: true

      - name: Purge cache
        run: |
          echo "â–¶ï¸ å¼€å§‹åˆ·æ–°ç¼“å­˜"
          urls=(
            "https://purge.jsdelivr.net/gh/g12777/TV/epg/e.xml"
            "https://purge.jsdelivr.net/gh/g12777/TV/epg/all.xml"
            "https://purge.jsdelivr.net/gh/g12777/TV/epg/112114.xml"
            "https://purge.jsdelivr.net/gh/g12777/TV/epg/plsy1_1d.xml"
            "https://purge.jsdelivr.net/gh/g12777/TV/epg/plsy1_7d.xml"
            "https://purge.jsdelivr.net/gh/g12777/TV/epg/1d.xml"
            "https://purge.jsdelivr.net/gh/g12777/TV/epg/7d.xml"
            "https://tvsilo.vip/app/epg.php"
          )

          for url in "${urls[@]}"; do
            echo "ğŸ”„ åˆ·æ–°ï¼š$url"
            curl -s -X GET "$url" || echo "âš ï¸ åˆ·æ–°å¤±è´¥ï¼š$url"
          done

          echo "âœ… ç¼“å­˜åˆ·æ–°å®Œæˆ"
